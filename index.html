<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flappy Terra Lite</title>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: #000;
}

#gameCanvas {
  display: block;
  margin: auto;
  background: #FFD700;
  image-rendering: pixelated;
}

#ui {
  position: absolute;
  top: 10px;
  left: 10px;
  color: black;
  font-weight: bold;
  z-index: 10;
}

button {
  padding: 5px 8px;
  margin-top: 4px;
  margin-right: 5px;
  border: none;
  background: #003366;
  color: white;
  border-radius: 5px;
}
</style>
</head>
<body>

<div id="ui">
  <div id="walletStatus">Wallet: Not Connected</div>
  <button onclick="connectWallet()">Connect</button>
  <button onclick="disconnectWallet()">Disconnect</button>
  <div>Score: <span id="score">0</span></div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

// ===== FIXED INTERNAL RESOLUTION (LOWER = SMOOTHER)
const INTERNAL_WIDTH = 360;
const INTERNAL_HEIGHT = 640;

canvas.width = INTERNAL_WIDTH;
canvas.height = INTERNAL_HEIGHT;

// Scale canvas visually
canvas.style.width = "100vw";
canvas.style.height = "100vh";

// ===== LOAD IMAGE
const birdImg = new Image();
birdImg.src = "terra.png";

// ===== GAME STATE
let birdY = 300;
let velocity = 0;
const gravity = 1000;
const jumpForce = -350;

const birdSize = 50;

let pipeX = INTERNAL_WIDTH;
let pipeTop = 200;
const pipeGap = 180;
const pipeWidth = 60;
const pipeSpeed = 180;

let score = 0;
let gameOver = false;
let lastTime = 0;

// ===== INPUT
function jump() {
  if (gameOver) {
    resetGame();
    return;
  }
  velocity = jumpForce;
}

window.addEventListener("touchstart", jump);
window.addEventListener("keydown", e => {
  if (e.code === "Space") jump();
});

// ===== GAME LOOP
function gameLoop(timestamp) {

  if (!lastTime) lastTime = timestamp;
  let delta = (timestamp - lastTime) / 1000;
  lastTime = timestamp;

  if (delta > 0.03) delta = 0.03;

  // Paint background
  ctx.fillStyle = "#FFD700";
  ctx.fillRect(0, 0, INTERNAL_WIDTH, INTERNAL_HEIGHT);

  if (!gameOver) {

    velocity += gravity * delta;
    birdY += velocity * delta;

    pipeX -= pipeSpeed * delta;

    if (pipeX < -pipeWidth) {
      pipeX = INTERNAL_WIDTH;
      pipeTop = Math.random() * 300 + 50;
      score++;
      document.getElementById("score").innerText = score;
    }

    // Collision
    if (
      100 < pipeX + pipeWidth &&
      100 + birdSize > pipeX &&
      (birdY < pipeTop || birdY + birdSize > pipeTop + pipeGap)
    ) {
      gameOver = true;
    }

    if (birdY > INTERNAL_HEIGHT - birdSize) {
      gameOver = true;
    }
  }

  // Draw pipe
  ctx.fillStyle = "#003366";
  ctx.fillRect(pipeX, 0, pipeWidth, pipeTop);
  ctx.fillRect(pipeX, pipeTop + pipeGap, pipeWidth, INTERNAL_HEIGHT);

  // Draw bird
  ctx.drawImage(birdImg, 100, birdY, birdSize, birdSize);

  // Game over text
  if (gameOver) {
    ctx.fillStyle = "black";
    ctx.font = "24px Arial";
    ctx.fillText("GAME OVER", 110, 300);
    ctx.font = "16px Arial";
    ctx.fillText("Tap to Restart", 120, 330);
  }

  requestAnimationFrame(gameLoop);
}

birdImg.onload = () => requestAnimationFrame(gameLoop);

// ===== RESET
function resetGame() {
  birdY = 300;
  velocity = 0;
  pipeX = INTERNAL_WIDTH;
  score = 0;
  document.getElementById("score").innerText = 0;
  gameOver = false;
}

// ===== WALLET
let connectedWallet = null;

async function connectWallet() {

  if (!window.keplr) {
    alert("Keplr tidak terdeteksi");
    return;
  }

  try {
    await window.keplr.enable("columbus-5");
    const offlineSigner = window.getOfflineSigner("columbus-5");
    const accounts = await offlineSigner.getAccounts();
    connectedWallet = accounts[0].address;

    document.getElementById("walletStatus").innerText =
      "Wallet: " + connectedWallet.slice(0,10) + "...";

  } catch {
    alert("Gagal connect wallet");
  }
}

function disconnectWallet() {
  connectedWallet = null;
  document.getElementById("walletStatus").innerText =
    "Wallet: Not Connected";
}
</script>

</body>
</html>
