<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flappy Terra Classic</title>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: #000;
  font-family: Arial, sans-serif;
}

#gameCanvas {
  display: none;
  margin: auto;
  background: #FFD700;
  image-rendering: pixelated;
}

#ui {
  position: absolute;
  top: 10px;
  left: 10px;
  color: black;
  font-weight: bold;
  z-index: 10;
  display: none;
}

button {
  padding: 10px;
  margin: 5px;
  border: none;
  background: #003366;
  color: white;
  border-radius: 5px;
  cursor: pointer;
  width: 230px;
}

#menuBox {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  background: #FFD700;
  padding: 30px;
  border-radius: 10px;
  text-align: center;
}
</style>
</head>
<body>

<div id="ui">
  <div id="walletStatus"></div>
  <button onclick="disconnectWallet()">Disconnect</button>
  <div>Score: <span id="score">0</span></div>
  <div>Highscore: <span id="highscore">0</span></div>
</div>

<div id="menuBox">
  <h2>Main Menu</h2>
  <button onclick="startGame()">Play Game</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

// ===== LOAD IMAGE =====
const birdImg = new Image();
birdImg.src = "terra.png";

// ===== STATE =====
let walletConnected = false;
let connectedWallet = null;
let gameRunning = false;

let birdY = 200;
let velocity = 0;
let gravity = 1200;
let jumpForce = -450;

let pipes = [];
let pipeTimer = 0;
let pipeInterval = 2;

let score = 0;
let highscore = localStorage.getItem("highscore") || 0;
document.getElementById("highscore").innerText = highscore;

let lastTime = 0;
let gameOver = false;

const birdSize = 60;
const pipeWidth = 70;
const pipeGap = 200;
const pipeSpeed = 200;

// ===== DEVICE DETECT =====
function isMobile() {
  return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

// ===== START GAME =====
async function startGame(){

  // MOBILE
  if(isMobile()){

    // If opened inside Keplr mobile browser
    if(window.keplr){
      await connectWallet();
    } else {
      alert("Please open this game inside Keplr Mobile Browser.");
      return;
    }

  } else {
    // DESKTOP
    await connectWallet();
  }

  if(walletConnected){
    document.getElementById("menuBox").style.display="none";
    document.getElementById("ui").style.display="block";
    canvas.style.display="block";
    gameRunning = true;
  }
}

// ===== CONNECT WALLET =====
async function connectWallet(){

  if(!window.keplr){
    alert("Keplr not detected.");
    return;
  }

  try{
    await window.keplr.enable("columbus-5");
    const signer = window.getOfflineSigner("columbus-5");
    const accounts = await signer.getAccounts();

    connectedWallet = accounts[0].address;
    walletConnected = true;

    document.getElementById("walletStatus").innerText =
      "Wallet: " + connectedWallet.slice(0,10) + "...";

  }catch{
    alert("Connection failed");
  }
}

// ===== INPUT =====
function jump(){
  if(!gameRunning) return;

  if(gameOver){
    resetGame();
    return;
  }

  velocity = jumpForce;
}
window.addEventListener("keydown", e=>{ if(e.code==="Space") jump();});
window.addEventListener("touchstart", jump);

// ===== PIPE =====
function createPipe(){
  const top = Math.random()*(canvas.height-pipeGap-100)+50;
  pipes.push({x:canvas.width,top:top,bottom:top+pipeGap,passed:false});
}

// ===== GAME LOOP =====
function gameLoop(timestamp){
  if(!lastTime) lastTime=timestamp;
  let delta=(timestamp-lastTime)/1000;
  lastTime=timestamp;
  if(delta>0.033) delta=0.033;

  if(gameRunning){
    ctx.fillStyle="#FFD700";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    if(!gameOver){
      velocity+=gravity*delta;
      birdY+=velocity*delta;

      pipeTimer+=delta;
      if(pipeTimer>pipeInterval){
        createPipe();
        pipeTimer=0;
      }

      ctx.fillStyle="#003366";
      for(let i=pipes.length-1;i>=0;i--){
        let pipe=pipes[i];
        pipe.x-=pipeSpeed*delta;

        ctx.fillRect(pipe.x,0,pipeWidth,pipe.top);
        ctx.fillRect(pipe.x,pipe.bottom,pipeWidth,canvas.height);

        if(
          100<pipe.x+pipeWidth &&
          100+birdSize>pipe.x &&
          (birdY<pipe.top || birdY+birdSize>pipe.bottom)
        ){ gameOver=true; }

        if(!pipe.passed && pipe.x<100){
          pipe.passed=true;
          score++;
          document.getElementById("score").innerText=score;
        }

        if(pipe.x<-pipeWidth){ pipes.splice(i,1);}
      }

      if(birdY>canvas.height-birdSize){ gameOver=true; }
    }

    ctx.drawImage(birdImg,100,birdY,birdSize,birdSize);

    if(gameOver){
      ctx.fillStyle="black";
      ctx.font="30px Arial";
      ctx.fillText("GAME OVER",canvas.width/2-90,canvas.height/2);
    }
  }

  requestAnimationFrame(gameLoop);
}
birdImg.onload=()=>requestAnimationFrame(gameLoop);

// ===== RESET =====
function resetGame(){
  score=0;
  document.getElementById("score").innerText=0;
  pipes=[];
  velocity=0;
  birdY=200;
  pipeTimer=0;
  gameOver=false;
}

// ===== DISCONNECT =====
function disconnectWallet(){
  walletConnected=false;
  connectedWallet=null;
  gameRunning=false;

  document.getElementById("ui").style.display="none";
  canvas.style.display="none";
  document.getElementById("menuBox").style.display="block";
}
</script>

</body>
</html>
