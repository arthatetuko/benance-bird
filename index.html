<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flappy Terra Classic</title>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: #000;
  font-family: Arial, sans-serif;
}

#gameCanvas {
  display: block;
  margin: auto;
  background: black;
}

#ui {
  position: absolute;
  top: 10px;
  left: 10px;
  color: white;
  z-index: 10;
}

button {
  padding: 6px 10px;
  margin-top: 5px;
  margin-right: 5px;
  border: none;
  background: #ff9900;
  color: white;
  font-weight: bold;
  border-radius: 5px;
  cursor: pointer;
}

button:hover {
  opacity: 0.8;
}
</style>
</head>

<body>

<div id="ui">
  <div id="walletStatus">Wallet: Not Connected</div>
  <button onclick="connectWallet()">Connect Keplr</button>
  <button onclick="disconnectWallet()">Disconnect</button>
  <div>Score: <span id="score">0</span></div>
  <div>Highscore: <span id="highscore">0</span></div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
// ===== CANVAS =====
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
ctx.imageSmoothingEnabled = false;

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

// ===== LOAD SPRITE =====
const birdImg = new Image();
birdImg.src = "benance.png";

// ===== GAME VARIABLES =====
let birdY = 200;
let velocity = 0;
let gravity = 1200;
let pipes = [];
let score = 0;
let highscore = localStorage.getItem("highscore") || 0;
document.getElementById("highscore").innerText = highscore;

let lastTime = 0;
let bgOffset = 0;
let crashFlash = 0;
let screenShake = 0;

// ===== INPUT =====
function jump() {
  velocity = -450;
}

window.addEventListener("keydown", e => {
  if (e.code === "Space") jump();
});

window.addEventListener("touchstart", jump);

// ===== PIPE SPAWN =====
function createPipe() {
  const gap = 180;
  const top = Math.random() * (canvas.height - gap - 100) + 50;

  pipes.push({
    x: canvas.width,
    top: top,
    bottom: top + gap,
    passed: false
  });
}
setInterval(createPipe, 2000);

// ===== GAME LOOP =====
function gameLoop(timestamp) {
  const delta = (timestamp - lastTime) / 1000;
  lastTime = timestamp;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // ===== BACKGROUND RETRO =====
  bgOffset -= 100 * delta;
  if (bgOffset <= -40) bgOffset = 0;

  for (let x = bgOffset; x < canvas.width; x += 40) {
    ctx.fillStyle = "#111122";
    ctx.fillRect(x, 0, 20, canvas.height);
  }

  // ===== SCREEN SHAKE =====
  let shakeX = (Math.random() - 0.5) * screenShake;
  let shakeY = (Math.random() - 0.5) * screenShake;
  ctx.save();
  ctx.translate(shakeX, shakeY);

  // ===== PHYSICS =====
  velocity += gravity * delta;
  birdY += velocity * delta;

  // ===== SPRITE ANIMATION (3 FRAME) =====
  const frameWidth = birdImg.width / 3;
  const frameHeight = birdImg.height;
  const currentFrame = Math.floor(Date.now() / 150) % 3;

  ctx.drawImage(
    birdImg,
    currentFrame * frameWidth, 0,
    frameWidth, frameHeight,
    100, birdY,
    80, 80
  );

  // ===== PIPES =====
  ctx.fillStyle = "#00ff88";

  pipes.forEach(pipe => {
    pipe.x -= 200 * delta;

    ctx.fillRect(pipe.x, 0, 50, pipe.top);
    ctx.fillRect(pipe.x, pipe.bottom, 50, canvas.height);

    // collision
    if (
      100 < pipe.x + 50 &&
      180 > pipe.x &&
      (birdY < pipe.top || birdY + 80 > pipe.bottom)
    ) {
      resetGame();
    }

    if (!pipe.passed && pipe.x < 100) {
      pipe.passed = true;
      score++;
      document.getElementById("score").innerText = score;
    }
  });

  ctx.restore();

  // ===== CRASH FLASH =====
  if (crashFlash > 0) {
    ctx.fillStyle = "rgba(255,0,0," + crashFlash + ")";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    crashFlash -= delta;
  }

  if (screenShake > 0) {
    screenShake -= 40 * delta;
  }

  requestAnimationFrame(gameLoop);
}
requestAnimationFrame(gameLoop);

// ===== RESET =====
function resetGame() {
  if (score > highscore) {
    highscore = score;
    localStorage.setItem("highscore", highscore);
    document.getElementById("highscore").innerText = highscore;
  }

  score = 0;
  document.getElementById("score").innerText = 0;
  pipes = [];
  birdY = 200;
  velocity = 0;

  crashFlash = 1;
  screenShake = 20;
}

// ===== WALLET (KEPLR) =====
let connectedWallet = null;

async function connectWallet() {
  if (!window.keplr) {
    alert("Keplr tidak terdeteksi (Desktop only)");
    return;
  }

  try {
    await window.keplr.enable("columbus-5");
    const offlineSigner = window.getOfflineSigner("columbus-5");
    const accounts = await offlineSigner.getAccounts();

    connectedWallet = accounts[0].address;

    document.getElementById("walletStatus").innerText =
      "Wallet: " + connectedWallet;
  } catch (err) {
    console.log(err);
    alert("Gagal connect wallet");
  }
}

function disconnectWallet() {
  connectedWallet = null;
  document.getElementById("walletStatus").innerText =
    "Wallet: Not Connected";
}
</script>

</body>
</html>
