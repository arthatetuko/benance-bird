<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flappy Terra Classic</title>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: #000;
  font-family: Arial, sans-serif;
}

#gameCanvas {
  display: none;
  margin: auto;
  background: #FFD700;
  image-rendering: pixelated;
}

#ui {
  position: absolute;
  top: 10px;
  left: 10px;
  color: black;
  font-weight: bold;
  z-index: 10;
  display: none;
}

button {
  padding: 10px;
  margin: 5px;
  border: none;
  background: #003366;
  color: white;
  border-radius: 5px;
  cursor: pointer;
  width: 230px;
}

#menuBox, #connectChoice {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  background: #FFD700;
  padding: 30px;
  border-radius: 10px;
  text-align: center;
}
</style>
</head>
<body>

<div id="ui">
  <div id="walletStatus"></div>
  <button onclick="disconnectWallet()">Disconnect</button>
  <div>Score: <span id="score">0</span></div>
  <div>Highscore: <span id="highscore">0</span></div>
</div>

<div id="menuBox">
  <h2>Main Menu</h2>
  <button onclick="showConnectOptions()">Play Game</button>
</div>

<div id="connectChoice" style="display:none;">
  <h3>Choose Wallet</h3>
  <button onclick="connectDesktop()">ðŸ–¥ Connect Desktop</button>
  <button onclick="backToMenu()">Back</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

// ===== LOAD FRAMES =====
const birdFrame1 = new Image();
birdFrame1.src = "terra1.png";

const birdFrame2 = new Image();
birdFrame2.src = "terra2.png";

let currentFrame = 0;
let frameTimer = 0;
const frameInterval = 0.12;

// ===== SOUND (8 BIT) =====
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playJumpSound(){
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = "square";
  osc.frequency.setValueAtTime(600, audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(200, audioCtx.currentTime + 0.1);

  gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);

  osc.connect(gain);
  gain.connect(audioCtx.destination);

  osc.start();
  osc.stop(audioCtx.currentTime + 0.1);
}

// ===== STATE =====
let walletConnected = false;
let connectedWallet = null;
let gameRunning = false;

let birdY = 200;
let velocity = 0;
let gravity = 1200;
let jumpForce = -450;

let pipes = [];
let pipeTimer = 0;
let pipeInterval = 2;

let score = 0;
let highscore = parseInt(localStorage.getItem("highscore")) || 0;
document.getElementById("highscore").innerText = highscore;

let lastTime = 0;
let gameOver = false;

let flashAlpha = 0;

const birdSize = 70;
const pipeWidth = 70;
const pipeGap = 200;
const pipeSpeed = 200;

// ===== WALLET FORMAT =====
function formatWallet(addr){
  return addr.slice(0,6)+"..."+addr.slice(-4);
}

// ===== MENU =====
function showConnectOptions(){
  document.getElementById("menuBox").style.display="none";
  document.getElementById("connectChoice").style.display="block";
}
function backToMenu(){
  document.getElementById("connectChoice").style.display="none";
  document.getElementById("menuBox").style.display="block";
}

async function connectDesktop(){
  if(!window.keplr){
    alert("Keplr not detected");
    return;
  }
  try{
    await window.keplr.enable("columbus-5");
    const signer = window.getOfflineSigner("columbus-5");
    const accounts = await signer.getAccounts();

    connectedWallet = accounts[0].address;
    walletConnected = true;
    startGame();
  }catch{
    alert("Connection failed");
  }
}

function startGame(){
  document.getElementById("connectChoice").style.display="none";
  document.getElementById("ui").style.display="block";
  canvas.style.display="block";

  document.getElementById("walletStatus").innerText =
    "Wallet: "+formatWallet(connectedWallet);

  gameRunning = true;
}

// ===== INPUT =====
function jump(){
  if(!gameRunning) return;

  if(gameOver){
    resetGame();
    return;
  }

  velocity = jumpForce;
  playJumpSound();
}
window.addEventListener("keydown", e=>{ if(e.code==="Space") jump();});
window.addEventListener("touchstart", jump);

// ===== PIPE =====
function createPipe(){
  const top = Math.random()*(canvas.height-pipeGap-100)+50;
  pipes.push({x:canvas.width,top:top,bottom:top+pipeGap,passed:false});
}

// ===== GAME LOOP =====
function gameLoop(timestamp){

  if(!lastTime) lastTime=timestamp;
  let delta=(timestamp-lastTime)/1000;
  lastTime=timestamp;
  if(delta>0.033) delta=0.033;

  if(gameRunning){

    ctx.fillStyle="#FFD700";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    if(!gameOver){
      velocity+=gravity*delta;
      birdY+=velocity*delta;

      pipeTimer+=delta;
      if(pipeTimer>pipeInterval){
        createPipe();
        pipeTimer=0;
      }

      ctx.fillStyle="#003366";
      for(let i=pipes.length-1;i>=0;i--){
        let pipe=pipes[i];
        pipe.x-=pipeSpeed*delta;

        ctx.fillRect(pipe.x,0,pipeWidth,pipe.top);
        ctx.fillRect(pipe.x,pipe.bottom,pipeWidth,canvas.height);

        if(
          100<pipe.x+pipeWidth &&
          100+birdSize>pipe.x &&
          (birdY<pipe.top || birdY+birdSize>pipe.bottom)
        ){
          gameOver=true;
          flashAlpha=0.5;
        }

        if(!pipe.passed && pipe.x<100){
          pipe.passed=true;
          score++;
          document.getElementById("score").innerText=score;

          if(score>highscore){
            highscore=score;
            localStorage.setItem("highscore",highscore);
            document.getElementById("highscore").innerText=highscore;
          }
        }

        if(pipe.x<-pipeWidth){ pipes.splice(i,1);}
      }

      if(birdY>canvas.height-birdSize){
        gameOver=true;
        flashAlpha=0.5;
      }
    }

    // ===== FRAME ANIMATION =====
    frameTimer+=delta;
    if(frameTimer>frameInterval){
      currentFrame = currentFrame===0?1:0;
      frameTimer=0;
    }

    const birdImage = currentFrame===0?birdFrame1:birdFrame2;

    // ===== ROTATION =====
    let rotation = velocity * 0.002;
    if(rotation>0.5) rotation=0.5;
    if(rotation<-0.5) rotation=-0.5;

    ctx.save();
    ctx.translate(100+birdSize/2, birdY+birdSize/2);
    ctx.rotate(rotation);

    // ===== SHADOW =====
    ctx.fillStyle="rgba(0,0,0,0.3)";
    ctx.fillRect(-birdSize/2+5, birdSize/2-5, birdSize, 10);

    ctx.drawImage(
      birdImage,
      -birdSize/2,
      -birdSize/2,
      birdSize,
      birdSize
    );

    ctx.restore();

    // ===== HIT FLASH =====
    if(flashAlpha>0){
      ctx.fillStyle="rgba(255,0,0,"+flashAlpha+")";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      flashAlpha-=delta;
    }

    if(gameOver){
      ctx.fillStyle="black";
      ctx.font="30px Arial";
      ctx.fillText("GAME OVER",canvas.width/2-90,canvas.height/2);
    }
  }

  requestAnimationFrame(gameLoop);
}

Promise.all([
  new Promise(res=>birdFrame1.onload=res),
  new Promise(res=>birdFrame2.onload=res)
]).then(()=>requestAnimationFrame(gameLoop));

// ===== RESET =====
function resetGame(){
  score=0;
  document.getElementById("score").innerText=0;
  pipes=[];
  velocity=0;
  birdY=200;
  pipeTimer=0;
  gameOver=false;
}

// ===== DISCONNECT =====
function disconnectWallet(){
  walletConnected=false;
  connectedWallet=null;
  gameRunning=false;

  document.getElementById("ui").style.display="none";
  canvas.style.display="none";
  document.getElementById("menuBox").style.display="block";
}
</script>

</body>
</html>
