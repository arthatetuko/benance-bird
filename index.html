<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flappy Terra Classic</title>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: #000;
  font-family: Arial, sans-serif;
}

#gameCanvas {
  display: block;
  margin: auto;
  background: #FFD700;
}

#ui {
  position: absolute;
  top: 10px;
  left: 10px;
  color: black;
  font-weight: bold;
  z-index: 10;
}

button {
  padding: 6px 10px;
  margin-top: 5px;
  margin-right: 5px;
  border: none;
  background: #003366;
  color: white;
  border-radius: 5px;
}
</style>
</head>
<body>

<div id="ui">
  <div id="walletStatus">Wallet: Not Connected</div>
  <button id="connectBtn" onclick="connectWallet()">Connect Keplr</button>
  <button id="disconnectBtn" onclick="disconnectWallet()" style="display:none;">Disconnect</button>
  <div>Score: <span id="score">0</span></div>
  <div>Highscore: <span id="highscore">0</span></div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

// ===== LOAD GIF (ANIMATED)
const birdImg = new Image();
birdImg.src = "terra.gif"; // GANTI dengan nama GIF kamu

// ===== GAME STATE
let walletConnected = false;

let birdY = 200;
let velocity = 0;
let gravity = 1200;
let jumpForce = -450;

let pipes = [];
let pipeTimer = 0;
let pipeInterval = 2;

let score = 0;
let highscore = localStorage.getItem("highscore") || 0;
document.getElementById("highscore").innerText = highscore;

let lastTime = 0;
let gameOver = false;

const birdSize = 60;
const pipeWidth = 70;
const pipeGap = 200;
const pipeSpeed = 200;

// ===== INPUT
function jump() {
  if (!walletConnected) return;

  if (gameOver) {
    resetGame();
    return;
  }

  velocity = jumpForce;
}

window.addEventListener("keydown", e => {
  if (e.code === "Space") jump();
});
window.addEventListener("touchstart", jump);

// ===== PIPE SPAWN
function createPipe() {
  const top = Math.random() * (canvas.height - pipeGap - 100) + 50;
  pipes.push({
    x: canvas.width,
    top: top,
    bottom: top + pipeGap,
    passed: false
  });
}

// ===== GAME LOOP
function gameLoop(timestamp) {

  if (!lastTime) lastTime = timestamp;
  let delta = (timestamp - lastTime) / 1000;
  lastTime = timestamp;

  if (delta > 0.033) delta = 0.033;

  ctx.fillStyle = "#FFD700";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  if (walletConnected && !gameOver) {

    velocity += gravity * delta;
    birdY += velocity * delta;

    pipeTimer += delta;
    if (pipeTimer > pipeInterval) {
      createPipe();
      pipeTimer = 0;
    }

    ctx.fillStyle = "#003366";

    for (let i = pipes.length - 1; i >= 0; i--) {

      let pipe = pipes[i];
      pipe.x -= pipeSpeed * delta;

      ctx.fillRect(pipe.x, 0, pipeWidth, pipe.top);
      ctx.fillRect(pipe.x, pipe.bottom, pipeWidth, canvas.height);

      if (
        100 < pipe.x + pipeWidth &&
        100 + birdSize > pipe.x &&
        (birdY < pipe.top || birdY + birdSize > pipe.bottom)
      ) {
        gameOver = true;
      }

      if (!pipe.passed && pipe.x < 100) {
        pipe.passed = true;
        score++;
        document.getElementById("score").innerText = score;
      }

      if (pipe.x < -pipeWidth) {
        pipes.splice(i, 1);
      }
    }

    if (birdY > canvas.height - birdSize) {
      gameOver = true;
    }
  }

  // ===== DRAW GIF (AUTO ANIMATED)
  ctx.drawImage(birdImg, 100, birdY, birdSize, birdSize);

  if (!walletConnected) {
    ctx.fillStyle = "black";
    ctx.font = "24px Arial";
    ctx.fillText("Connect Wallet to Play", canvas.width/2 - 130, canvas.height/2);
  }

  if (gameOver) {
    ctx.fillStyle = "black";
    ctx.font = "30px Arial";
    ctx.fillText("GAME OVER", canvas.width/2 - 90, canvas.height/2);
    ctx.font = "18px Arial";
    ctx.fillText("Tap / Space to Restart", canvas.width/2 - 100, canvas.height/2 + 30);
  }

  requestAnimationFrame(gameLoop);
}

birdImg.onload = () => requestAnimationFrame(gameLoop);

// ===== RESET
function resetGame() {

  if (score > highscore) {
    highscore = score;
    localStorage.setItem("highscore", highscore);
    document.getElementById("highscore").innerText = highscore;
  }

  score = 0;
  document.getElementById("score").innerText = 0;

  pipes = [];
  velocity = 0;
  birdY = 200;
  pipeTimer = 0;
  gameOver = false;
}

// ===== WALLET
let connectedWallet = null;

async function connectWallet() {

  if (!window.keplr) {
    alert("Keplr tidak terdeteksi");
    return;
  }

  try {
    await window.keplr.enable("columbus-5");
    const offlineSigner = window.getOfflineSigner("columbus-5");
    const accounts = await offlineSigner.getAccounts();

    connectedWallet = accounts[0].address;
    walletConnected = true;

    document.getElementById("walletStatus").innerText =
      "Wallet: " + connectedWallet.slice(0,10) + "...";

    document.getElementById("connectBtn").style.display = "none";
    document.getElementById("disconnectBtn").style.display = "inline-block";

  } catch (err) {
    alert("Gagal connect wallet");
  }
}

function disconnectWallet() {
  connectedWallet = null;
  walletConnected = false;

  document.getElementById("walletStatus").innerText =
    "Wallet: Not Connected";

  document.getElementById("connectBtn").style.display = "inline-block";
  document.getElementById("disconnectBtn").style.display = "none";

  resetGame();
}
</script>

</body>
</html>
